name: ðŸš€ Deploy to Production

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Mithrandir
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”— Connect to Tailscale
      uses: tailscale/github-action@v2
      with:
        oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
        oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
        tags: tag:ci
      
    - name: ðŸ” Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.MITHRANDIR_SSH_KEY }}
        
    - name: ðŸ“ Add SSH known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H 100.77.230.53 >> ~/.ssh/known_hosts
        
    - name: ðŸš€ Deploy to production
      run: |
        ssh nbost@100.77.230.53 << 'ENDSSH'
          set -e
          
          echo "ðŸ“‚ Navigating to project directory..."
          cd /home/nbost/Projects/mithrandir-admin
          
          echo "ðŸ“¥ Pulling latest changes..."
          git pull origin main
          
          echo "ðŸ“¦ Installing dependencies..."
          npm install
          
          echo "ðŸ”¨ Building project..."
          npm run build
          
          echo "ðŸ”„ Restarting service..."
          systemctl --user restart mithrandir-admin
          
          echo "âœ… Verifying deployment..."
          sleep 5
          curl -f http://localhost:3000 || exit 1
          
          echo "ðŸŽ‰ Deployment successful!"
        ENDSSH

